<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fmyd888.fengmao.module.information.dal.mysql.transportdetail.TransportDetailMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
     -->
    <select id="selectDetailPage"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.transportdetail.vo.TransportDetailRespVO">
        SELECT
            t1.*,
            t2.id as entyId,
            t3.customer_name as loadFactoryName,
            t4.customer_name as unloadFactoryName,
            t2.transport_sdate,
            t2.transport_edae,
            t6.name as companyName
        FROM fm_transport_detail t1
            LEFT JOIN fm_transport_manger t2 on t2.id = t1.transport_id
            LEFT JOIN fm_customer t3 on t3.id = t2.load_factory_id AND t3.deleted = 0
            LEFT JOIN fm_customer t4 on t4.id = t2.unload_factory_id AND t4.deleted = 0
            LEFT JOIN system_dept t6 on t6.id = t2.company_id AND t6.deleted = 0
        WHERE t1.deleted = 0 AND t2.deleted = 0
        <if test="pageReqVO.keyword != null and pageReqVO.keyword != ''">
            AND (
            t1.transport_code LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t3.customer_name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t4.customer_name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t6.name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            )
        </if>
        <if test="pageReqVO.carId != null">
            AND t1.car_id LIKE CONCAT('%', #{pageReqVO.carId}, '%')
        </if>
            <if test="pageReqVO.loadFactoryId != null">
                AND t2.load_factory_id = #{pageReqVO.loadFactoryId}
            </if>
            <if test="pageReqVO.unloadFactoryId != null">
                AND t2.unload_factory_id = #{pageReqVO.unloadFactoryId}
            </if>
            <if test="pageReqVO.transportCode != null and pageReqVO.transportCode != ''">
                AND t1.id = #{pageReqVO.transportCode}
            </if>

            <if test="pageReqVO.queryDate != null and pageReqVO.queryDate.size() > 0">
                and t1.transport_sdate BETWEEN
                <foreach collection="pageReqVO.queryDate" item="date" separator=" AND ">
                    #{date}
                </foreach>
            </if>
            <if test="pageReqVO.queryDate != null and pageReqVO.queryDate.size() > 0">
                and t1.transport_edae BETWEEN
                <foreach collection="pageReqVO.queryDate" item="date" separator=" AND ">
                    #{date}
                </foreach>
            </if>
            <if test="pageReqVO.status != null and pageReqVO.status == 1">
                AND t1.status = 1
            </if>
            <if test="pageReqVO.status != null and pageReqVO.status == 2">
                AND t2.transport_tonnage &lt;= 20
            </if>
            <if test="pageReqVO.status != null and pageReqVO.status == 3">
                AND t1.status &gt; GETDATE()
            </if>
            ORDER BY t1.id DESC
    </select>

    <select id="selectBelow20Tons" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM fm_transport_manger t1
         join fm_transport_detail t2 on t1.id = t2.transport_id and t2.deleted = 0
         join system_dept t3 on t1.dept_id = t3.id and t3.deleted = 0
        WHERE  t1.deleted = 0
          and t2.transport_tonnage &lt;= 20
    </select>

    <select id="selectCompleted" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM fm_transport_manger t1
         join fm_transport_detail t2 on t1.id = t2.transport_id and t2.deleted = 0
         join system_dept t3 on t1.dept_id = t3.id and t3.deleted = 0
        WHERE t1.deleted = 0 and t1.status = 1
    </select>

    <select id="selectExperied" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM fm_transport_manger t1
         join fm_transport_detail t2 on t1.id = t2.transport_id and t2.deleted = 0
         join system_dept t3 on t1.dept_id = t3.id and t3.deleted = 0
        WHERE t1.deleted = 0 and t1.status &gt; GETDATE()
    </select>
    <insert id="batchInsertTransportCars">
        INSERT INTO fm_transport_car (car_id, transport_detail_id)
        VALUES
        <foreach collection="mainVehicles" item="mainVehicle" index="index" separator=",">
            (#{mainVehicle}, #{transportId})
        </foreach>
    </insert>
</mapper>
