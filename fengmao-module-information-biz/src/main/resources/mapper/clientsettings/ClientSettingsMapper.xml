<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fmyd888.fengmao.module.information.dal.mysql.clientsettings.ClientSettingsMapper">


    <delete id="deleteTrailerByClientId">
        UPDATE t2 set  t2.deleted = 1
        FROM fm_foreign_trailer_client t2
        INNER JOIN fm_client_settings t3 ON t2.client_id = t3.id
        WHERE t2.client_id = #{clientId}
          AND t2.deleted = 0
          AND t3.deleted = 0;
    </delete>

    <delete id="deleteVehicleByClientId">
        UPDATE t2 set  t2.deleted = 1
        FROM fm_foreign_vehicle_client t2
        INNER JOIN fm_client_settings t3 ON t2.foreign_vehicle_id = t3.id
        WHERE t2.client_id = #{clientId}
        AND t2.deleted = 0
        AND t3.deleted = 0;
    </delete>

    <delete id="deleteWechatByClientId">
        UPDATE t2 set  t2.deleted = 1
        FROM fm_foreign_wechat_client t2
        INNER JOIN fm_client_settings t3 ON t2.foreign_wechat_id = t3.id
        WHERE t2.client_id = #{clientId}
        AND t2.deleted = 0
        AND t3.deleted = 0;
    </delete>
    <delete id="deleteStatementTemplateByClientId">
        UPDATE t2 set  t2.deleted = 1
        FROM fm_statement_template t2
        INNER JOIN fm_client_settings t3 ON t2.entity_id = t3.id
        WHERE t2.entity_id = #{clientId}
        AND t2.deleted = 0
        AND t3.deleted = 0;
    </delete>



    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
     -->

    <select id="selectClientSettingsPage"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.clientsettings.vo.ClientSettingsRespVO">
        SELECT
        t1.id,
        t2.customer_name,
        t1.outsource_carrier,
        t1.pass_outsource_carrier,
        t1.vehicle_repairer,
        t1.pass_vehicle_repairer AS passVehicleRepairer,
        t1.create_time,
        t9.nickname AS creator,
        t10.Oil_engine AS OilEngine,
        t1.remark
        FROM
        fm_client_settings t1
        LEFT JOIN fm_customer t2 ON t2.id = t1.customer_id AND t2.deleted = 0
        LEFT JOIN fm_foreign_wechat_client t3 ON t3.client_id = t1.id AND t3.deleted = 0
        LEFT JOIN fm_wechat_bind t4 ON t4.id = t3.foreign_wechat_id AND t4.deleted = 0
        LEFT JOIN fm_foreign_vehicle_client t5 ON t5.client_id = t1.id AND t5.deleted = 0
        LEFT JOIN fm_main_vehicle t6 ON t6.id = t5.foreign_vehicle_id AND t6.deleted = 0
        LEFT JOIN fm_foreign_trailer_client t7 ON t7.client_id = t1.id AND t7.deleted = 0
        LEFT JOIN fm_trailer t8 ON t8.id = t7.foreign_trailer_id AND t8.deleted = 0
        LEFT JOIN system_users t9 ON t9.id = t1.creator AND t9.deleted = 0
        LEFT JOIN fm_oil_card t10 ON t10.id = t1.card_id AND t10.deleted = 0
        WHERE
        t1.deleted = 0
        <if test="pageReqVO.keyword != null and pageReqVO.keyword != ''">
            AND (
            t1.remark LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t2.customer_name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t4.name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t6.plate_number LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t8.vehicle_trailer_no LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t9.nickname LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t10.Oil_engine LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            <!-- 可以继续添加其他字段的模糊查询 -->
            )
        </if>
        <if test="pageReqVO.customerId != null">
            AND t1.customer_id = #{pageReqVO.customerId}
        </if>
        <if test="pageReqVO.outsourceCarrier != null">
            AND t1.outsource_carrier = #{pageReqVO.outsourceCarrier}
        </if>
        order by t1.id desc
    </select>

    <select id="selectClientSettingsDetail"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.clientsettings.dto.ClientSettingsDetailDTO">
        SELECT
            t1.id,
            t2.id as customerId,
            t2.customer_name,
            t1.outsource_carrier,
            t1.pass_outsource_carrier,
            t1.vehicle_repairer,
            t1.pass_vehicle_repairer AS passVehicleRepairer,
            STRING_AGG(t4.id, ', ') AS wechatId,
            STRING_AGG(t4.name, ', ') AS wechatNames, -- 合并多个wechat名称
            STRING_AGG(t6.id,', ') AS plateId,
            STRING_AGG(t6.plate_number,', ') AS plateNumber,
            STRING_AGG(t8.vehicle_trailer_no,', ') AS vehicleTrailerNo,
            STRING_AGG(t8.id,', ') AS vehicleTrailerId, -- 同上
            t1.create_time,
            t9.nickname AS creator,
            t1.remark,
            t10.id as cardId
        FROM
            fm_client_settings t1
                LEFT JOIN fm_customer t2 ON t2.id = t1.customer_id AND t2.deleted = 0
                LEFT JOIN fm_foreign_wechat_client t3 ON t3.client_id = t1.id AND t3.deleted = 0
                LEFT JOIN fm_wechat_bind t4 ON t4.id = t3.foreign_wechat_id AND t4.deleted = 0
                LEFT JOIN fm_foreign_vehicle_client t5 ON t5.client_id = t1.id AND t5.deleted = 0
                LEFT JOIN fm_main_vehicle t6 ON t6.id = t5.foreign_vehicle_id AND t6.deleted = 0
                LEFT JOIN fm_foreign_trailer_client t7 ON t7.client_id = t1.id AND t7.deleted = 0
                LEFT JOIN fm_trailer t8 ON t8.id = t7.foreign_trailer_id AND t8.deleted = 0
                LEFT JOIN system_users t9 ON t9.id = t1.creator AND t9.deleted = 0
                LEFT JOIN fm_oil_card t10 ON t10.id = t1.card_id AND t9.deleted = 0
        WHERE
            t1.id = #{id} and t1.deleted = 0
        GROUP BY
            t1.id,
            t2.id,
            t2.customer_name,
            t1.outsource_carrier,
            t1.pass_outsource_carrier,
            t1.vehicle_repairer,
            t1.pass_vehicle_repairer,
            t1.create_time,
            t9.nickname,
            t10.id,
            t1.remark;
    </select>

    <select id="selectWechatBindSimpleness"
            resultType="java.lang.Long">
        SELECT t1.id
        FROM fm_wechat_bind t1
                 LEFT JOIN fm_foreign_wechat_client t2 on t2.foreign_wechat_id = t1.id
                 LEFT JOIN fm_client_settings t3 on t3.id = t2.client_id
        WHERE t3.id = #{clientId}
          and t1.deleted = 0 and  t2.deleted = 0 and t3.deleted = 0
    </select>

    <select id="selectStatementSimpleness"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.clientsettings.dto.StatementTemplateSimplenessDTO">
        SELECT t1.id,t3.id as commodityId,t3.name,t1.file_ids
        FROM fm_statement_template t1
                 LEFT JOIN fm_client_settings t2 on t2.id = t1.entity_id
                 LEFT JOIN fm_commodity t3 on t3.id = t1.commodity_id
        WHERE t2.id =  #{clientId}
          and t1.deleted = 0 and  t2.deleted = 0 and t3.deleted = 0
    </select>

    <select id="selectVehicleSimpleness"
            resultType="java.lang.Long">
        SELECT t1.id
        FROM fm_main_vehicle t1
                 LEFT JOIN fm_foreign_vehicle_client t2 on t2.foreign_vehicle_id = t1.id
                 LEFT JOIN fm_client_settings t3 on t3.id = t2.client_id
        WHERE t3.id =  #{clientId}
          and t1.deleted = 0 and  t2.deleted = 0 and t3.deleted = 0
    </select>

    <select id="selectTrailerSimpleness"
            resultType="java.lang.Long">
        SELECT t1.id
        FROM fm_trailer t1
                 LEFT JOIN fm_foreign_trailer_client t2 on t2.foreign_trailer_id = t1.id
                 LEFT JOIN fm_client_settings t3 on t3.id = t2.client_id
        WHERE t3.id =  #{clientId}
          and t1.deleted = 0 and  t2.deleted = 0 and t3.deleted = 0
    </select>
    <select id="getForeignWechatClientPage"
        resultType="com.fmyd888.fengmao.module.information.controller.admin.clientsettings.vo.WechatBindRespVO">

        SELECT
            t1.id,
            t1.head_img_url,
            t1.nickname,
            t1.name,
            t1.sex,
            t1.remark,
            t3.customer_name,
            t2.create_time
        FROM fm_wechat_bind t1
                 LEFT JOIN fm_customer_wechat t2 on t2.foreign_wechat_id = t1.id
                 LEFT JOIN fm_customer t3 on t3.id = t2.customer_id
        WHERE t1.deleted = 0 and  t2.deleted = 0 and t3.deleted = 0
        <if test="pageReqVO.foreignWechatId != null">
            and t2.foreign_wechat_id = #{pageReqVO.foreignWechatId}
        </if>
    </select>
    <select id="selectWechatBindDetailsByWechatId"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.clientsettings.dto.WechatBindDetailsDTO">
        SELECT t1.id, t1.head_img_url, t1.nickname, t1.name, t1.sex, t1.remark
        FROM fm_wechat_bind t1
        WHERE t1.deleted = 0
          and t1.id = #{id}
    </select>
    <select id="selectListByWechatId"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.customer.dto.CustomerDTO">
        SELECT t1.id,t1.customer_name as name
        FROM fm_customer t1
         LEFT JOIN fm_customer_wechat t2 on t2.customer_id = t1.id
        WHERE t2.foreign_wechat_id = #{wechatId}
    </select>
    <select id="selectCustomerIdByWechatId" resultType="java.lang.Long">
        SELECT t1.customer_id
        FROM fm_customer_wechat t1
                 LEFT JOIN fm_wechat_bind t2 on t1.foreign_wechat_id = t2.id
                 LEFT JOIN fm_customer t3 on t3.id = t1.customer_id
        WHERE t2.foreign_wechat_id = #{wechatId}
    </select>
    <select id="selectForeignTrailerIdByClientId" resultType="java.lang.Long">
        SELECT t1.foreign_trailer_id
        FROM fm_foreign_trailer_client t1
                 LEFT JOIN fm_trailer t2 on t1.foreign_trailer_id = t2.id
                 LEFT JOIN fm_client_settings t3 on t1.client_id = t3.id
        WHERE t1.client_id = #{clientId}
    </select>

    <select id="selectClientSettingWechat" resultType="java.lang.String">
        SELECT
        t3.nickname
        FROM fm_client_settings t1
        LEFT JOIN fm_foreign_wechat_client t2 ON t2.client_id = t1.id AND t2.deleted = 0
        LEFT JOIN fm_wechat_bind t3 ON t3.id = t2.foreign_wechat_id AND t3.deleted = 0
        WHERE t1.deleted = 0
        AND t1.id = #{id}
        AND t3.nickname IS NOT NULL;
    </select>


    <select id="selectClientSettingMain" resultType="java.lang.String">
        SELECT
            t3.plate_number
        FROM fm_client_settings t1
                 LEFT JOIN fm_foreign_vehicle_client t2 on t2.client_id = t1.id AND t2.deleted = 0
                 LEFT JOIN fm_main_vehicle t3  on t3.id = t2.foreign_vehicle_id AND t3.deleted = 0
        WHERE  t1.deleted = 0
        AND t1.id = #{id}
        AND t3.plate_number IS NOT NULL;
    </select>
    <select id="selectClientSettingTrailer" resultType="java.lang.String">
        SELECT
            t3.vehicle_trailer_no
        FROM fm_client_settings t1
                 LEFT JOIN fm_foreign_trailer_client t2 on t2.client_id = t1.id AND t2.deleted = 0
                 LEFT JOIN fm_trailer t3  on t3.id = t2.foreign_trailer_id AND t3.deleted = 0
        WHERE  t1.deleted = 0
        AND t1.id = #{id}
        AND t3.vehicle_trailer_no IS NOT NULL;
    </select>

</mapper>
