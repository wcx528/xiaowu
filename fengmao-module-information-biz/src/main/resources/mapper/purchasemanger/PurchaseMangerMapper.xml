<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fmyd888.fengmao.module.information.dal.mysql.purchasemanger.PurchaseMangerMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
     -->
    <select id="selectPageByKeyword"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.purchasemanger.vo.PurchaseMangerRespVO">
        SELECT t1.*,
        t2.name as deptName
        FROM fm_purchase_manger t1
        left join system_dept t2 on t1.dept_id = t2.id and t2.deleted= 0
        <where>
            t1.deleted = 0
            <if test="pageReqVO.keyword != null and pageReqVO.keyword != ''">
                and CONCAT(
                t1.purchase_code, ' ' ,
                t1.purchase_unit, ' ' ,
                t1.salse_unit, ' ' ,
                t1.purchase_tonnage, ' ' ,
                t1.surplus_quantity, ' ',
                t2.name
                ) LIKE '%' + #{pageReqVO.keyword} + '%' COLLATE Chinese_PRC_CI_AS
            </if>
            <if test="pageReqVO.purchaseCode != null and pageReqVO.purchaseCode != ''">
                AND t1.id = #{pageReqVO.purchaseCode}
            </if>
            <if test="pageReqVO.purchaseUnit != null and pageReqVO.purchaseUnit != ''">
                AND t1.purchase_unit = #{pageReqVO.purchaseUnit}
            </if>
            <if test="pageReqVO.salseUnit != null and pageReqVO.salseUnit != ''">
                AND t1.salse_unit = #{pageReqVO.salseUnit}
            </if>
            <if test="pageReqVO.type != null and pageReqVO.type != ''">
                AND t1.type = #{pageReqVO.type}
            </if>
            <if test="pageReqVO.deptId != null and pageReqVO.deptId != ''">
                AND t1.dept_id = #{pageReqVO.deptId}
            </if>
            <if test="pageReqVO.status != null and pageReqVO.status == 1">
                AND t1.status = 1
            </if>
            <if test="pageReqVO.status != null and pageReqVO.status == 2">
                AND t1.status = 2
            </if>
            <if test="pageReqVO.status != null and pageReqVO.status == 3">
                AND (t1.purchase_etime &gt;= DATEADD(DAY, -7, GETDATE())
                or t1.surplus_quantity &lt;= (t1.purchase_tonnage * 0.2))
            </if>
        </where>
        <if test="pageReqVO.orderByColumn != null and pageReqVO.orderByColumn != '' and pageReqVO.sortMode != null and pageReqVO.sortMode != ''">
            ORDER BY t1.${pageReqVO.orderByColumn} ${pageReqVO.sortMode}
        </if>
    </select>
    <select id="selectCountInProgress" resultType="java.lang.Long">
        select count(*)
        from fm_purchase_manger t1
        where t1.deleted = 0
          and t1.status = #{status}
    </select>

    <select id="selectExpirationReminder" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM fm_purchase_manger t1
        WHERE t1.deleted = 0
          and (t1.purchase_etime &gt;= DATEADD(DAY, -7, GETDATE())
            OR t1.surplus_quantity &lt;= (t1.purchase_tonnage * 0.2))
    </select>

</mapper>
