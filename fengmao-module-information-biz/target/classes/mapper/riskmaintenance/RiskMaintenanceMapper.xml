<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fmyd888.fengmao.module.information.dal.mysql.riskmaintenance.RiskMaintenanceMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
     -->

    <select id="selectTripInspectionDetails" resultType="com.fmyd888.fengmao.module.information.controller.admin.riskmaintenance.dto.TripInspectionDetailsRespDTO">
        SELECT
         t1.id -- 去重id，查询唯一的
        FROM fm_risk_maintenance t1
        LEFT JOIN fm_risk_maintenance_commodity t2 ON t2.entity_id = t1.id
        WHERE t1.type = #{type}
        AND t1.company_id = #{companyId}
        <if test="commodityId != null and !commodityId.isEmpty()">
            AND t2.commodity_id IN
            <foreach collection="commodityId" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        AND t1.check_type = #{checkType}
    </select>
    <select id="selectRiskInspectionItemDetailsById" resultType="com.fmyd888.fengmao.module.information.dal.dataobject.riskmaintenance.RiskInspectionItemDO">
        SELECT
            t1.id,t1.project_name,t1.Item_score
        FROM fm_risk_inspection_item t1
            LEFT JOIN fm_risk_maintenance t2 ON t2.id = t1.entity_id
        WHERE t2.id = #{id} and t1.deleted = 0 and t2.deleted = 0
    </select>
    <select id="selectRiskMaintenanceDetailsById"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.riskmaintenance.dto.RiskMaintenanceOuterDTO">
        SELECT check_category,id
        FROM fm_risk_maintenance
        WHERE type = #{type} and check_type = #{checkType} and company_id = #{companyId} and deleted = 0
    </select>
    <select id="selectRiskInspectionItemDetailsById2"
            resultType="com.fmyd888.fengmao.module.information.dal.dataobject.riskmaintenance.RiskInspectionItemDO">
        SELECT
            t1.id,t1.project_name,t1.is_upload_pictures
        FROM fm_risk_inspection_item t1
                 LEFT JOIN fm_risk_maintenance t2 ON t2.id = t1.entity_id
        WHERE t2.id = #{id} and t1.deleted = 0 and t2.deleted = 0
    </select>
    <select id="selectCommodityIdsById" resultType="java.lang.Long">
        SELECT t1.commodity_id
        FROM fm_risk_maintenance_commodity t1
                 LEFT JOIN fm_risk_maintenance t2 on t2.id = t1.entity_id
        WHERE t1.entity_id = #{entityId} and t1.deleted = 0 and t2.deleted = 0
    </select>
    <select id="selectRiskInspectionItemById"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.riskmaintenance.dto.RiskInspectionItemOuterDTO">
        SELECT TOP (1) check_type, type, company_id,id
        FROM fm_risk_maintenance
        WHERE type = #{type} and check_type = #{checkType} and company_id = #{companyId}
        and deleted = 0
    </select>
    <select id="selectRiskMaintenanceIds" resultType="java.lang.Long">
        SELECT id
        FROM fm_risk_maintenance
        WHERE type = #{type} and check_type = #{checkType} and company_id = #{companyId} and deleted = 0
    </select>
    <select id="selectOldItemIdsByEntityId" resultType="java.lang.Long">
        SELECT t1.id
        FROM fm_risk_inspection_item t1
                 LEFT JOIN fm_risk_maintenance t2 on t2.id = t1.entity_id
        WHERE t1.entity_id = #{entityId} and t2.deleted = 0 and t1.deleted = 0
    </select>
</mapper>
