<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fmyd888.fengmao.module.information.dal.mysql.socialsecuritybase.SocialSecurityBaseMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
     -->

    <select id="selectClientSettingsPage"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.socialsecuritybase.vo.SocialSecurityBaseRespVO">
        SELECT
        STRING_AGG(t3.id, ',') AS deptId,
--         STRING_AGG(t3.name, ',') AS deptName,
        t1.id,
        t1.insurance_type,
        t1.insurance_grade,
        t1.security_cardinal,
        t1.health_cardina,
        t1.accumulation_cardina,
        t1.explain_grade,
        t1.remark,
        t1.personage_annuity,
        t1.personage_medical,
        t1.personage_big_medical,
        t1.personage_unemployment,
        t1.personage_accumulation,
        t1.unit_annuity,
        t1.unit_medical,
        t1.unit_big_medical,
        t1.unit_unemployment,
        t1.unit_accumulation,
        t1.employment_injury,
        t1.Long_term
        FROM fm_social_security_base t1
        LEFT JOIN fm_social_security_base_dept t2 ON t2.entity_id = t1.id AND t2.deleted = 0
        LEFT JOIN system_dept t3 ON t3.id = t2.dept_id AND t3.deleted = 0
        WHERE t1.deleted = 0
        GROUP BY t1.id, t1.insurance_type, t1.insurance_grade, t1.security_cardinal,
        t1.health_cardina, t1.accumulation_cardina, t1.explain_grade,
        t1.remark, t1.personage_annuity, t1.personage_medical,
        t1.personage_big_medical, t1.personage_unemployment,
        t1.personage_accumulation, t1.unit_annuity, t1.unit_medical,
        t1.unit_big_medical, t1.unit_unemployment, t1.unit_accumulation,
        t1.employment_injury, t1.Long_term
        <if test="pageReqVO.keyword != null and pageReqVO.keyword != ''">
            AND (
            t1.remark LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            OR t3.name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
            <!-- 可以继续添加其他字段的模糊查询 -->
            )
        </if>
        <if test="pageReqVO.insuranceType != null and pageReqVO.insuranceType != ''">
            and t1.insurance_type = #{pageReqVO.insuranceType}
        </if>
        <if test="pageReqVO.insuranceGrade != null and pageReqVO.insuranceGrade != ''">
            and t1.insurance_grade = #{pageReqVO.insuranceGrade}
        </if>
        <if test="pageReqVO.deptId != null and pageReqVO.deptId != ''">
            and t1.dept_id = #{pageReqVO.deptId} and t2.deleted = 0
        </if>

    </select>
</mapper>
