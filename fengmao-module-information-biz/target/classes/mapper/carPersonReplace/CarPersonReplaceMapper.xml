<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fmyd888.fengmao.module.information.dal.mysql.carpersonreplace.CarPersonReplaceMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
     -->
    <select id="selectPageByKeyword"
            resultType="com.fmyd888.fengmao.module.information.controller.admin.carpersonreplace.vo.CarPersonReplaceRespVO">
        SELECT
            t1.id,
             t2.plate_number,
             t3.name AS currentFleetName,
             t4.vehicle_trailer_no AS currentTrailerNo,
             t5.nickname AS currentMainUser,
             t6.nickname AS currentDeputyUser,
             t7.nickname AS currentEscortUser,
             t8.name AS oldFleetName,
             t9.vehicle_trailer_no AS oldTrailerNo,
             t10.nickname AS oldMainUser,
             t11.nickname AS oldDeputyUser,
             t12.nickname AS oldEscortUser,
             t1.replace_time,
             t1.replace_remark,
             t1.status,
             t1.apply_user_time,
             t14.nickname as applyUserName,
             t13.name AS departmentName,
             t1.remark
        FROM fm_car_person_replace t1
            LEFT JOIN fm_main_vehicle t2 ON t2.id = t1.car_id -- 车牌号
            LEFT JOIN fm_fleet t3 ON t3.id = t1.fleet_id -- 车队
            LEFT JOIN fm_trailer t4 ON t4.id = t1.trailer_id -- 车挂
            LEFT JOIN system_users t5 ON t5.id = t1.main_id -- 主驾
            LEFT JOIN system_users t6 ON t6.id = t1.deputy_id -- 副驾
            LEFT JOIN system_users t7 ON t7.id = t1.escort_id -- 押运员
            LEFT JOIN fm_fleet t8 ON t8.id = t1.old_fleet_id -- 前车队
            LEFT JOIN fm_trailer t9 ON t9.id = t1.old_trailer_id -- 前车挂
            LEFT JOIN system_users t10 ON t10.id = t1.old_main_id -- 前主驾
            LEFT JOIN system_users t11 ON t11.id = t1.old_deputy_id -- 前副驾
            LEFT JOIN system_users t12 ON t12.id = t1.old_escort_id -- 前押运员
            LEFT JOIN system_dept t13 ON t13.id = t1.dept_id -- 公司
            LEFT JOIN system_users t14 ON t14.id = t1.apply_user_id -- 申请人
        WHERE
             t1.deleted = 0
             AND (t2.deleted = 0 OR t2.deleted IS NULL)
             AND (t3.deleted = 0 OR t3.deleted IS NULL)
             AND (t4.deleted = 0 OR t4.deleted IS NULL)
             AND (t5.deleted = 0 OR t5.deleted IS NULL)
             AND (t6.deleted = 0 OR t6.deleted IS NULL)
             AND (t7.deleted = 0 OR t7.deleted IS NULL)
             AND (t8.deleted = 0 OR t8.deleted IS NULL)
             AND (t9.deleted = 0 OR t9.deleted IS NULL)
             AND (t10.deleted = 0 OR t10.deleted IS NULL)
             AND (t11.deleted = 0 OR t11.deleted IS NULL)
             AND (t12.deleted = 0 OR t12.deleted IS NULL)
             AND (t13.deleted = 0 OR t13.deleted IS NULL)
             AND (t14.deleted = 0 OR t14.deleted IS NULL)
            <if test="pageReqVO.keyword != null and pageReqVO.keyword != ''">
                AND (
                t2.plate_number LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t3.name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t4.vehicle_trailer_no LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t5.nickname LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t6.nickname LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t7.nickname LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t8.name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t9.vehicle_trailer_no LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t10.nickname LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t11.nickname LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t12.nickname LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t13.name LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t14.nickname LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t1.replace_remark LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                OR t1.remark LIKE CONCAT('%', #{pageReqVO.keyword}, '%')
                )
            </if>
            <if test="pageReqVO.carId != null">
                AND t1.car_id = #{pageReqVO.carId}
            </if>
            <if test="pageReqVO.replaceType != null">
                AND t1.replace_type = #{pageReqVO.replaceType}
            </if>
            <if test="pageReqVO.fleetId != null">
                AND t1.fleet_id = #{pageReqVO.fleetId}
            </if>
            <if test="pageReqVO.applyUserId != null">
                AND t14.id = #{pageReqVO.applyUserId}
            </if>
            <if test="pageReqVO.deptId != null">
                AND t1.dept_id = #{pageReqVO.deptId}
            </if>
            <if test="pageReqVO.status != null">
                AND t1.status = #{pageReqVO.status}
            </if>
        <if test="pageReqVO.timeRange != null and pageReqVO.timeRange.size() > 0">
            <choose>
                <when test="pageReqVO.timeRange.size() == 1">
                    <if test="pageReqVO.timeRange[0] != null">
                        AND t1.replace_time >= #{pageReqVO.timeRange[0]}
                    </if>
                </when>
                <when test="pageReqVO.timeRange.size() == 2">
                    <if test="pageReqVO.timeRange[0] != null">
                        AND t1.replace_time >= #{pageReqVO.timeRange[0]}
                    </if>
                    <if test="pageReqVO.timeRange[1] != null">
                        AND t1.replace_time &lt;= #{pageReqVO.timeRange[1]}
                    </if>
                </when>
                <otherwise>
                    <if test="pageReqVO.timeRange[1] != null">
                        AND t1.replace_time &lt;= #{pageReqVO.timeRange[1]}
                    </if>
                </otherwise>
            </choose>
        </if>
            <if test="pageReqVO.oldFleetId != null">
            AND t1.old_fleet_id = #{pageReqVO.oldFleetId}
            </if>
            <if test="pageReqVO.mainId != null">
            AND t1.main_id = #{pageReqVO.mainId}
            </if>
            <if test="pageReqVO.oldMainId != null">
            AND t1.old_main_id = #{pageReqVO.oldMainId}
            </if>
            <if test="pageReqVO.deputyId != null">
            AND t1.deputy_id = #{pageReqVO.deputyId}
            </if>
            <if test="pageReqVO.oldDeputyId != null">
            AND t1.old_deputy_id = #{pageReqVO.deputyId}
            </if>
            <if test="pageReqVO.escortId != null">
            AND t1.escort_id = #{pageReqVO.escortId}
            </if>
            <if test="pageReqVO.oldEscortId != null">
            AND t1.old_escort_id = #{pageReqVO.oldEscortId}
            </if>
            <if test="pageReqVO.trailerId != null">
            AND t1.trailer_id = #{pageReqVO.trailerId}
            </if>
            <if test="pageReqVO.oldTrailerId != null">
            AND t1.old_trailer_id = #{pageReqVO.oldTrailerId}
            </if>
        ORDER BY t1.${pageReqVO.sortField} ${pageReqVO.collationValue}
    </select>

 </mapper>

